<!DOCTYPE html>
<html lang="zh" xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>徐晓伟工作室</title>

    <!-- 跨站请求伪造 -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" th:href="@{/layui/css/layui.css}">

    <link rel="stylesheet" th:href="@{/css/home.css}">

</head>
<body>

<div class="layui-container XXW-t-a-c">

    <h3>主页</h3>

    <h4 sec:authorize="!isAuthenticated()">你还未登录！</h4>

    <h4 sec:authorize="isAuthenticated()">你已登录</h4>

    <div sec:authorize="!isAuthenticated()">
        <a th:href="@{/login}" class="XXW-a">登录</a>
        <a th:href="@{/login}" class="XXW-a">注册</a>
    </div>

    <div sec:authorize="isAuthenticated()" class="active" data-type="logout">
        退出登录
    </div>

</div>

</body>

<script type="text/javascript" th:src="@{/layui/layui.js}"></script>

<script th:inline="javascript" type="text/javascript">
    layui.use(['layer'], function () {
        var $ = layui.$,
            layer = layui.layer;

        /* 跨站请求伪造 */
        var header = $("meta[name='_csrf_header']").attr("content");
        var token = $("meta[name='_csrf']").attr("content");

        //触发事件
        var active = {
            logout: function () {

                console.log("logout");

                $.ajax({
                    url: "/logout.do",
                    type: "post",
                    beforeSend: function (xhr) {
                        /* 跨站请求伪造 */
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (res) {
                        // console.log("success", res);

                        var code = res.code;
                        var msg = res.msg;

                        if (code === 0) {
                            layer.msg(msg, {icon: 1}, function () {
                                location.reload();
                            })
                        } else if (code === 1) {
                            layer.msg(msg, {icon: 0})
                        }

                    },
                    error: function (res) {
                        console.log("error", res);
                        layer.msg("退出登录时发生错误，请稍后再试！", {icon: 0})
                    }
                })
            }
        };

        $(".active").on("click", function () {
            var othis = $(this), type = othis.data("type");
            active[type] ? active[type].call(this, othis) : "";
        });

    });
</script>

</html>